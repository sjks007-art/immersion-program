# app.py - ì§ì¥ì¸ ëª°ì… ì²´í—˜ í”„ë¡œê·¸ë¨ (UI ê°œì„ íŒ)
import streamlit as st
import time
from datetime import datetime
import json
from pathlib import Path
import random

# í˜ì´ì§€ ì„¤ì • - ë” ê¹”ë”í•œ UI
st.set_page_config(
    page_title="ëª°ì… ì²´í—˜ í”„ë¡œê·¸ë¨",
    page_icon="ğŸ¯",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ìë™ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™”ë¥¼ ìœ„í•œ ì„¤ì •
if 'last_update' not in st.session_state:
    st.session_state.last_update = time.time()

# ë°ì´í„° ì €ì¥ ê²½ë¡œ
DATA_DIR = Path("immersion_data")
DATA_DIR.mkdir(exist_ok=True)
USER_DATA_FILE = DATA_DIR / "user_data.json"
SESSIONS_FILE = DATA_DIR / "sessions.json"

# ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜
def load_user_data():
    if USER_DATA_FILE.exists():
        with open(USER_DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}

def save_user_data(data):
    with open(USER_DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def load_sessions():
    if SESSIONS_FILE.exists():
        with open(SESSIONS_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return []

def save_session(session_data):
    sessions = load_sessions()
    sessions.append(session_data)
    with open(SESSIONS_FILE, 'w', encoding='utf-8') as f:
        json.dump(sessions, f, ensure_ascii=False, indent=2)
    return sessions

# CSS ìŠ¤íƒ€ì¼ (ê¹œë¹¡ì„ ì œê±°)
st.markdown("""
<style>
    /* Streamlit ê¸°ë³¸ ìš”ì†Œ ìˆ¨ê¸°ê¸° */
    #MainMenu {visibility: hidden;}
    .stDeployButton {display:none;}
    header {visibility: hidden;}
    footer {visibility: hidden;}
    .block-container {padding-top: 2rem;}
    
    /* ì§„í–‰ ë‹¨ê³„ í‘œì‹œ */
    .step-container {
        display: flex;
        justify-content: space-between;
        margin: 2rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }
    .step-item {
        flex: 1;
        text-align: center;
        padding: 1rem;
        margin: 0 0.5rem;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .step-active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .step-completed {
        background: #4CAF50;
        color: white;
    }
    .step-pending {
        background: #e0e0e0;
        color: #999;
    }
    
    /* íƒ€ì´ë¨¸ - ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    .timer-display {
        font-size: 5rem;
        font-weight: bold;
        color: #667eea;
        text-align: center;
        margin: 2rem 0;
        font-family: 'Courier New', monospace;
    }
    
    /* í˜¸í¡ ì› - ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ */
    .breathing-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        transition: all 0.5s ease;
    }
    .breathe-in {
        background: radial-gradient(circle, #87CEEB, #1976D2);
        transform: scale(1.2);
    }
    .breathe-out {
        background: radial-gradient(circle, #FFB6C1, #FF69B4);
        transform: scale(0.8);
    }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .stButton>button {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .stButton>button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* ë ˆë²¨ ë°°ì§€ */
    .level-badge {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        font-weight: bold;
        margin: 0.5rem;
        font-size: 1.1rem;
    }
    .level-beginner { 
        background: linear-gradient(135deg, #4CAF50, #8BC34A); 
        color: white; 
    }
    .level-intermediate { 
        background: linear-gradient(135deg, #FF9800, #FFB74D); 
        color: white; 
    }
    .level-advanced { 
        background: linear-gradient(135deg, #9C27B0, #BA68C8); 
        color: white; 
    }
    
    /* Spinner ìˆ¨ê¸°ê¸° */
    .stSpinner > div {
        display: none !important;
    }
</style>
""", unsafe_allow_html=True)

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'page' not in st.session_state:
    st.session_state.page = 'home'
if 'user_name' not in st.session_state:
    st.session_state.user_name = ''
if 'immersion_step' not in st.session_state:
    st.session_state.immersion_step = 0
if 'immersion_active' not in st.session_state:
    st.session_state.immersion_active = False
if 'start_time' not in st.session_state:
    st.session_state.start_time = None
if 'thoughts' not in st.session_state:
    st.session_state.thoughts = []
if 'current_topic' not in st.session_state:
    st.session_state.current_topic = ''
if 'breathing_done' not in st.session_state:
    st.session_state.breathing_done = False
if 'timer_placeholder' not in st.session_state:
    st.session_state.timer_placeholder = None
if 'selected_quote' not in st.session_state:
    # ì„¸ì…˜ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ëª…ì–¸ ì„ íƒ
    st.session_state.selected_quote = None

# í™©ë†ë¬¸ êµìˆ˜ë‹˜ ì¸ìš©êµ¬
QUOTES = [
    "ëª°ì…ì€ ê¸´ì¥ì´ ì•„ë‹ˆë¼ ì´ì™„ì…ë‹ˆë‹¤.",
    "1ì´ˆ ì›ì¹™: ì˜ì‹ì˜ ì¡°ëª…ì„ ë‹¨ 1ì´ˆë„ ë‹¤ë¥¸ ê³³ì— ë¹„ì¶”ì§€ ë§ˆì„¸ìš”.",
    "ì²œì²œíˆ ì˜¤ë˜ ìƒê°í•˜ëŠ” ê²ƒì´ ë¹¨ë¦¬ ìƒê°í•˜ëŠ” ê²ƒë³´ë‹¤ ì¤‘ìš”í•©ë‹ˆë‹¤.",
    "ë‡Œì˜ ì•ˆì „í•œ ë†€ì´í„°ë¥¼ ë§Œë“œì„¸ìš”.",
    "ìŠ¬ë¡œì‹±í‚¹ì€ ëŠë¦¬ê²Œ ìƒê°í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì˜¤ë˜ ìƒê°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.",
    "ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ í•˜ì§€ ë§ê³ , ë¬¸ì œì™€ í•¨ê»˜ ë¨¸ë¬¼ëŸ¬ë³´ì„¸ìš”.",
    "ì˜ì‹ì  ì´ì™„ì´ ì§„ì •í•œ ëª°ì…ì˜ ì‹œì‘ì…ë‹ˆë‹¤.",
    "í¬ê¸°í•˜ì§€ ì•Šê³  ê³„ì† ìƒê°í•˜ë©´ ë°˜ë“œì‹œ ë‹µì´ ë‚˜ì˜µë‹ˆë‹¤.",
    "ëª°ì…ì˜ ì¦ê±°ì›€ì„ ì•„ëŠ” ì‚¬ëŒì€ ì¸ìƒì´ í–‰ë³µí•©ë‹ˆë‹¤."
]

# ë ˆë²¨ë³„ ì£¼ì œ
TOPICS = {
    "ì´ˆê¸‰": [
        "ì˜¤ëŠ˜ í•˜ë£¨ ê°ì‚¬í•œ ê²ƒ 3ê°€ì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
        "ë‚˜ì˜ ê°€ì¥ í° ì¥ì ì€ ë¬´ì—‡ì¼ê¹Œìš”?",
        "ì˜¤ëŠ˜ ê°€ì¥ í–‰ë³µí–ˆë˜ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?",
        "ë‚´ê°€ ì •ë§ ì¢‹ì•„í•˜ëŠ” ì¼ì€ ë¬´ì—‡ì¸ê°€ìš”?"
    ],
    "ì¤‘ê¸‰": [
        "ì§€ë‚œ 1ë…„ê°„ ë‚˜ë¥¼ ê°€ì¥ ì„±ì¥ì‹œí‚¨ ê²½í—˜ì€?",
        "ë‚˜ì—ê²Œ ì„±ê³µì´ë€ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ê°€?",
        "ì‹¤íŒ¨ì—ì„œ ë°°ìš´ ê°€ì¥ ì¤‘ìš”í•œ êµí›ˆì€?",
        "ë‚´ ì¼ì´ ì„¸ìƒì— ì£¼ëŠ” ê°€ì¹˜ëŠ” ë¬´ì—‡ì¸ê°€?"
    ],
    "ê³ ê¸‰": [
        "5ë…„ í›„ ë‚´ê°€ ë˜ê³  ì‹¶ì€ ëª¨ìŠµê³¼ ê·¸ë¥¼ ìœ„í•œ í˜„ì¬ì˜ ë…¸ë ¥ì€?",
        "ì¸ìƒì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ë‚˜ë§Œì˜ ê¸°ì¤€ì€?",
        "ë‚´ê°€ ì„¸ìƒì— ë‚¨ê¸°ê³  ì‹¶ì€ ìœ ì‚°ì€ ë¬´ì—‡ì¸ê°€?",
        "ì§„ì •í•œ í–‰ë³µì˜ ì¡°ê±´ì€ ë¬´ì—‡ì´ë¼ê³  ìƒê°í•˜ëŠ”ê°€?"
    ]
}

def get_user_level(session_count):
    if session_count < 5:
        return "ì´ˆê¸‰", "ğŸŒ±", 1
    elif session_count < 20:
        return "ì¤‘ê¸‰", "ğŸŒ¿", 2
    else:
        return "ê³ ê¸‰", "ğŸŒ³", 3

def format_time(seconds):
    mins = int(seconds // 60)
    secs = int(seconds % 60)
    return f"{mins:02d}:{secs:02d}"

# ë°ì´í„° ë¡œë“œ
user_data = load_user_data()
sessions = load_sessions()

# í—¤ë”
st.markdown("<h1 style='text-align: center;'>ğŸ¯ ì§ì¥ì¸ ëª°ì… ì²´í—˜ í”„ë¡œê·¸ë¨</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: center; color: gray;'>í™©ë†ë¬¸ êµìˆ˜ë‹˜ì˜ ëª°ì… ì² í•™ ê¸°ë°˜</p>", unsafe_allow_html=True)
st.markdown("---")

# ì‚¬ì´ë“œë°”
with st.sidebar:
    st.markdown("### ğŸ“Œ ë©”ë‰´")
    
    menu_items = {
        "ğŸ  í™ˆ": "home",
        "ğŸ¯ ëª°ì… ì‹œì‘": "immersion",
        "ğŸ“Š ë‚˜ì˜ í†µê³„": "stats",
        "ğŸ“ ë³´ê³ ì„œ": "report",
        "â„¹ï¸ ë„ì›€ë§": "help"
    }
    
    for label, page_id in menu_items.items():
        if st.button(label, key=f"nav_{page_id}", use_container_width=True):
            st.session_state.page = page_id
            if page_id == "immersion" and st.session_state.user_name:
                st.session_state.immersion_step = 1
            st.rerun()
    
    st.markdown("---")
    
    # ì‚¬ìš©ì ì •ë³´
    if st.session_state.user_name:
        user_sessions = [s for s in sessions if s.get('user') == st.session_state.user_name]
        level, emoji, _ = get_user_level(len(user_sessions))
        
        st.markdown(f"### {emoji} {st.session_state.user_name}")
        st.markdown(f"**ë ˆë²¨:** {level}")
        st.markdown(f"**ì´ ëª°ì…:** {len(user_sessions)}íšŒ")
        
        total_time = sum(s.get('duration', 0) for s in user_sessions)
        st.markdown(f"**ëˆ„ì  ì‹œê°„:** {format_time(total_time)}")
    
    st.markdown("---")
    
    # ì˜¤ëŠ˜ì˜ ì§€í˜œ - ê³ ì •ëœ ëª…ì–¸ í‘œì‹œ
    if not st.session_state.selected_quote:
        st.session_state.selected_quote = random.choice(QUOTES)
    
    # Containerë¡œ ê³ ì • ì˜ì—­ ìƒì„±
    quote_container = st.container()
    with quote_container:
        st.info(f"ğŸ’¡ **ì˜¤ëŠ˜ì˜ ì§€í˜œ**\n\n_{st.session_state.selected_quote}_\n\n- í™©ë†ë¬¸")

# ë©”ì¸ ì½˜í…ì¸ 
if st.session_state.page == "home":
    # í™ˆ í˜ì´ì§€ ë‚´ìš© (ê³ ì •ëœ ì»¨í…Œì´ë„ˆ ì‚¬ìš©)
    intro_container = st.container()
    with intro_container:
        st.markdown("## ğŸ  í™˜ì˜í•©ë‹ˆë‹¤!")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("""
            ### ğŸ“– í”„ë¡œê·¸ë¨ ì†Œê°œ
            
            ì´ í”„ë¡œê·¸ë¨ì€ **í™©ë†ë¬¸ êµìˆ˜ë‹˜ì˜ ëª°ì… ì´ë¡ **ì„ ë°”íƒ•ìœ¼ë¡œ
            ì§ì¥ì¸ë“¤ì´ ì¼ìƒì—ì„œ ì‰½ê²Œ ëª°ì…ì„ ì²´í—˜í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            #### âœ¨ í•µì‹¬ ê¸°ëŠ¥
            - ğŸ§˜ **ì˜ì‹ì  ì´ì™„** - 4-8 í˜¸í¡ë²•
            - ğŸ’­ **ìŠ¬ë¡œì‹±í‚¹ í›ˆë ¨** - ì²œì²œíˆ ì˜¤ë˜ ìƒê°í•˜ê¸°
            - â±ï¸ **ì‹¤ì‹œê°„ íƒ€ì´ë¨¸** - ìë™ ì¸¡ì •
            - ğŸ“ˆ **ë ˆë²¨ ì‹œìŠ¤í…œ** - ì„±ì¥ ê°€ì‹œí™”
            """)
        
        with col2:
            st.markdown("""
            ### ğŸ¯ ëª°ì…ì˜ 3ë‹¨ê³„
            
            **1ï¸âƒ£ ì¤€ë¹„ ë‹¨ê³„** (ì„ íƒ)
            - ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­
            - ë¬¼ í•œ ëª¨ê¸ˆ
            
            **2ï¸âƒ£ ì´ì™„ ë‹¨ê³„** 
            - í˜¸í¡ ëª…ìƒìœ¼ë¡œ ë§ˆìŒ ì•ˆì •
            
            **3ï¸âƒ£ ëª°ì… ë‹¨ê³„**
            - ì£¼ì œì— ê¹Šì´ ì§‘ì¤‘
            
            > **"ëª°ì…ì€ ê¸´ì¥ì´ ì•„ë‹ˆë¼ ì´ì™„ì…ë‹ˆë‹¤"**
            """)
    
    if not st.session_state.user_name:
        st.markdown("---")
        st.markdown("### ğŸš€ ì‹œì‘í•˜ê¸°")
        name = st.text_input("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", placeholder="ì˜ˆ: í™ê¸¸ë™")
        if st.button("í”„ë¡œê·¸ë¨ ì‹œì‘", type="primary", use_container_width=True):
            if name:
                st.session_state.user_name = name
                user_data[name] = {"created_at": datetime.now().isoformat()}
                save_user_data(user_data)
                st.session_state.page = "immersion"
                st.session_state.immersion_step = 1
                st.rerun()

elif st.session_state.page == "immersion":
    if not st.session_state.user_name:
        st.warning("ë¨¼ì € í™ˆì—ì„œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        if st.button("í™ˆìœ¼ë¡œ ê°€ê¸°"):
            st.session_state.page = "home"
            st.rerun()
    else:
        st.markdown("## ğŸ¯ ëª°ì… í›ˆë ¨")
        
        user_sessions = [s for s in sessions if s.get('user') == st.session_state.user_name]
        level, emoji, level_num = get_user_level(len(user_sessions))
        
        st.markdown(f"<div class='level-badge level-{'beginner' if level_num==1 else 'intermediate' if level_num==2 else 'advanced'}'>{emoji} {st.session_state.user_name}ë‹˜ - {level} ë ˆë²¨</div>", unsafe_allow_html=True)
        
        # ì§„í–‰ ë‹¨ê³„ í‘œì‹œ
        st.markdown("""
        <div class='step-container'>
            <div class='step-item {}'>1ï¸âƒ£ ì¤€ë¹„</div>
            <div class='step-item {}'>2ï¸âƒ£ ì´ì™„</div>
            <div class='step-item {}'>3ï¸âƒ£ ëª°ì…</div>
        </div>
        """.format(
            'step-completed' if st.session_state.immersion_step > 1 else 'step-active' if st.session_state.immersion_step == 1 else 'step-pending',
            'step-completed' if st.session_state.immersion_step > 2 else 'step-active' if st.session_state.immersion_step == 2 else 'step-pending',
            'step-active' if st.session_state.immersion_step == 3 else 'step-pending'
        ), unsafe_allow_html=True)
        
        # ë‹¨ê³„ë³„ ë‚´ìš©
        if st.session_state.immersion_step == 1:
            # 1ë‹¨ê³„: ì¤€ë¹„
            st.markdown("### 1ï¸âƒ£ ëª°ì… ì¤€ë¹„")
            st.success("ğŸ’¡ ì¤€ë¹„ í•­ëª©ì€ ëª¨ë‘ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤. ì²´í¬ ì—†ì´ë„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤!")
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**ê°€ë²¼ìš´ ì¤€ë¹„** (ê¶Œì¥)")
                exercise = st.checkbox("ğŸ¤¸ ì›€ì§ì„ (ìŠ¤íŠ¸ë ˆì¹­, ëª© ëŒë¦¬ê¸° ë“±)", key="check_exercise")
                water = st.checkbox("ğŸ’§ ìˆ˜ë¶„ (ë¬¼ í•œ ëª¨ê¸ˆ)", key="check_water")
            
            with col2:
                st.markdown("**í™˜ê²½** (ì„ íƒ)")
                phone = st.checkbox("ğŸ“± ë°©í•´ ê¸ˆì§€ ëª¨ë“œ", key="check_phone")
                comfort = st.checkbox("ğŸª‘ í¸ì•ˆí•œ ìì„¸", key="check_comfort")
            
            checked_count = sum([exercise, water, phone, comfort])
            
            st.markdown("---")
            
            if checked_count == 0:
                st.info("ë°”ë¡œ ì‹œì‘í•˜ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤! ì¤€ë¹„ëŠ” ì„ íƒì…ë‹ˆë‹¤.")
            elif checked_count <= 2:
                st.info(f"ê°€ë²¼ìš´ ì¤€ë¹„ ì™„ë£Œ! ({checked_count}ê°œ ì„ íƒ)")
            else:
                st.success(f"ì² ì €í•œ ì¤€ë¹„! ({checked_count}ê°œ ì„ íƒ)")
            
            if st.button("ë‹¤ìŒ ë‹¨ê³„ë¡œ â†’", type="primary", use_container_width=True):
                st.session_state.immersion_step = 2
                st.rerun()
        
        elif st.session_state.immersion_step == 2:
            # 2ë‹¨ê³„: ì´ì™„
            st.markdown("### 2ï¸âƒ£ ì˜ì‹ì  ì´ì™„")
            st.info("í™©ë†ë¬¸ êµìˆ˜ë‹˜: 'ì´ì™„ëœ ì§‘ì¤‘'ì´ ì§„ì •í•œ ëª°ì…ì˜ ì‹œì‘ì…ë‹ˆë‹¤")
            
            if level_num == 1:
                inhale, exhale, rounds = 3, 6, 2
                st.markdown("ğŸŒ± **ì´ˆê¸‰ ì„¤ì •**: 3-6 í˜¸í¡, 2íšŒ ë°˜ë³µ")
            elif level_num == 2:
                inhale, exhale, rounds = 4, 8, 3
                st.markdown("ğŸŒ¿ **ì¤‘ê¸‰ ì„¤ì •**: 4-8 í˜¸í¡, 3íšŒ ë°˜ë³µ")
            else:
                inhale, exhale, rounds = 5, 10, 3
                st.markdown("ğŸŒ³ **ê³ ê¸‰ ì„¤ì •**: 5-10 í˜¸í¡, 3íšŒ ë°˜ë³µ")
            
            col1, col2 = st.columns(2)
            
            with col1:
                if st.button("ğŸ§˜ í˜¸í¡ ëª…ìƒ ì‹œì‘", type="primary", use_container_width=True):
                    placeholder = st.empty()
                    progress_bar = st.progress(0)
                    
                    total_steps = rounds * (inhale + exhale)
                    current_step = 0
                    
                    for round in range(rounds):
                        # ë“¤ìˆ¨
                        for i in range(inhale):
                            current_step += 1
                            progress_bar.progress(current_step / total_steps)
                            
                            placeholder.markdown(f"""
                            <div style='text-align: center; padding: 2rem;'>
                                <div class='breathing-circle breathe-in'>ğŸ«</div>
                                <h2 style='margin-top: 1rem;'>ìˆ¨ì„ ë“¤ì´ë§ˆì‹œì„¸ìš”</h2>
                                <h3>ë¼ìš´ë“œ {round+1}/{rounds} | {i+1}/{inhale}ì´ˆ</h3>
                            </div>
                            """, unsafe_allow_html=True)
                            time.sleep(1)
                        
                        # ë‚ ìˆ¨
                        for i in range(exhale):
                            current_step += 1
                            progress_bar.progress(current_step / total_steps)
                            
                            placeholder.markdown(f"""
                            <div style='text-align: center; padding: 2rem;'>
                                <div class='breathing-circle breathe-out'>ğŸ˜®â€ğŸ’¨</div>
                                <h2 style='margin-top: 1rem;'>ì²œì²œíˆ ë‚´ì‰¬ì„¸ìš”</h2>
                                <h3>ë¼ìš´ë“œ {round+1}/{rounds} | {i+1}/{exhale}ì´ˆ</h3>
                            </div>
                            """, unsafe_allow_html=True)
                            time.sleep(1)
                    
                    placeholder.empty()
                    progress_bar.empty()
                    st.success("âœ… ì˜ì‹ì  ì´ì™„ ì™„ë£Œ!")
                    time.sleep(1)
                    st.session_state.immersion_step = 3
                    st.rerun()
            
            with col2:
                if st.button("ê±´ë„ˆë›°ê¸° â†’", type="secondary", use_container_width=True):
                    st.session_state.immersion_step = 3
                    st.rerun()
        
        elif st.session_state.immersion_step == 3:
            # 3ë‹¨ê³„: ëª°ì…
            st.markdown("### 3ï¸âƒ£ ìŠ¬ë¡œì‹±í‚¹ - ì²œì²œíˆ ì˜¤ë˜ ìƒê°í•˜ê¸°")
            
            if not st.session_state.immersion_active:
                st.info("ì´ì œ ë³¸ê²©ì ì¸ ëª°ì…ì„ ì‹œì‘í•©ë‹ˆë‹¤")
                
                topics = TOPICS[level]
                selected_topic = st.selectbox(
                    "ì˜¤ëŠ˜ì˜ ëª°ì… ì£¼ì œ",
                    topics + ["ì§ì ‘ ì…ë ¥"],
                    help="ë ˆë²¨ì— ë§ëŠ” ì£¼ì œê°€ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤"
                )
                
                if selected_topic == "ì§ì ‘ ì…ë ¥":
                    selected_topic = st.text_input("ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”")
                
                if st.button("ğŸš€ ëª°ì… ì‹œì‘", type="primary", use_container_width=True):
                    if selected_topic and selected_topic != "ì§ì ‘ ì…ë ¥":
                        st.session_state.immersion_active = True
                        st.session_state.start_time = time.time()
                        st.session_state.current_topic = selected_topic
                        st.session_state.thoughts = []
                        st.rerun()
            
            else:
                # ëª°ì… ì¤‘ - íƒ€ì´ë¨¸ í‘œì‹œë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ
                timer_container = st.container()
                
                # í˜„ì¬ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
                elapsed = time.time() - st.session_state.start_time
                
                # íƒ€ì´ë¨¸ì™€ ì£¼ì œ í‘œì‹œ
                with timer_container:
                    # ìˆ˜ë™ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ (ìë™ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
                    col1, col2, col3 = st.columns([1, 2, 1])
                    with col2:
                        st.markdown(f"<div class='timer-display'>{format_time(elapsed)}</div>", unsafe_allow_html=True)
                    
                    st.markdown(f"#### ğŸ“ ì£¼ì œ: {st.session_state.current_topic}")
                
                # ìƒê° ì…ë ¥
                thought = st.text_area(
                    "ğŸ’­ ë– ì˜¤ë¥´ëŠ” ìƒê°ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”",
                    height=150,
                    placeholder="ìƒê°ì„ ì…ë ¥í•˜ê³  'ê¸°ë¡' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”...",
                    key="thought_input"
                )
                
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    if st.button("ğŸ’¾ ìƒê° ê¸°ë¡", use_container_width=True):
                        if thought:
                            st.session_state.thoughts.append({
                                "time": format_time(time.time() - st.session_state.start_time),
                                "content": thought
                            })
                            st.success("ê¸°ë¡ë¨!")
                            st.rerun()
                
                with col2:
                    # íƒ€ì´ë¨¸ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ë²„íŠ¼
                    if st.button("â±ï¸ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸", use_container_width=True):
                        st.rerun()
                
                with col3:
                    if st.button("ğŸ ëª°ì… ì¢…ë£Œ", type="secondary", use_container_width=True):
                        # ì„¸ì…˜ ì €ì¥
                        final_duration = time.time() - st.session_state.start_time
                        session_data = {
                            "user": st.session_state.user_name,
                            "date": datetime.now().isoformat(),
                            "topic": st.session_state.current_topic,
                            "duration": final_duration,
                            "thoughts": st.session_state.thoughts
                        }
                        save_session(session_data)
                        
                        # ìƒíƒœ ì´ˆê¸°í™”
                        st.session_state.immersion_active = False
                        st.session_state.immersion_step = 0
                        st.session_state.breathing_done = False
                        
                        # ì„±ê³µ ë©”ì‹œì§€
                        st.success(f"ğŸ‰ ëª°ì… ì™„ë£Œ! {format_time(final_duration)}")
                        st.balloons()
                        
                        # ë³´ê³ ì„œ í˜ì´ì§€ë¡œ ìë™ ì´ë™
                        time.sleep(2)  # ì ì‹œ ëŒ€ê¸°
                        st.session_state.page = "report"
                        st.rerun()
                
                # ê¸°ë¡ëœ ìƒê°ë“¤ í‘œì‹œ
                if st.session_state.thoughts:
                    st.markdown("---")
                    st.markdown("#### ğŸ’­ ê¸°ë¡ëœ ìƒê°ë“¤")
                    for i, t in enumerate(st.session_state.thoughts, 1):
                        st.markdown(f"**{i}.** [{t['time']}] {t['content']}")
                
                # ë„ì›€ë§
                with st.expander("ğŸ’¡ ëª°ì… ë„ì›€ë§"):
                    st.markdown("""
                    - **íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸**: ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”
                    - **ìƒê° ê¸°ë¡**: ë– ì˜¤ë¥´ëŠ” ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”
                    - **ëª°ì… ì¢…ë£Œ**: ì–¸ì œë“  ì¢…ë£Œí•  ìˆ˜ ìˆìœ¼ë©°, ìë™ìœ¼ë¡œ ë³´ê³ ì„œê°€ ìƒì„±ë©ë‹ˆë‹¤
                    """)

elif st.session_state.page == "stats":
    st.markdown("## ğŸ“Š ë‚˜ì˜ ëª°ì… í†µê³„")
    
    user_sessions = [s for s in sessions if s.get('user') == st.session_state.user_name]
    
    if not user_sessions:
        st.info("ì•„ì§ ëª°ì… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëª°ì…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!")
    else:
        total_sessions = len(user_sessions)
        total_time = sum(s.get('duration', 0) for s in user_sessions)
        avg_time = total_time / total_sessions if total_sessions > 0 else 0
        
        level, emoji, level_num = get_user_level(total_sessions)
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ë ˆë²¨", f"{emoji} {level}")
        with col2:
            st.metric("ì´ ëª°ì…", f"{total_sessions}íšŒ")
        with col3:
            st.metric("ì´ ì‹œê°„", format_time(total_time))
        with col4:
            st.metric("í‰ê·  ì‹œê°„", format_time(avg_time))
        
        # ë ˆë²¨ ì§„í–‰ë¥ 
        st.markdown("### ğŸ“ˆ ë ˆë²¨ ì§„í–‰ë¥ ")
        if level_num == 1:
            progress = (total_sessions / 5) * 100
            st.progress(min(progress / 100, 1.0))
            st.info(f"ğŸŒ± ì¤‘ê¸‰ê¹Œì§€ {max(0, 5 - total_sessions)}íšŒ ë‚¨ì•˜ìŠµë‹ˆë‹¤!")
        elif level_num == 2:
            progress = ((total_sessions - 5) / 15) * 100
            st.progress(min(progress / 100, 1.0))
            st.info(f"ğŸŒ¿ ê³ ê¸‰ê¹Œì§€ {max(0, 20 - total_sessions)}íšŒ ë‚¨ì•˜ìŠµë‹ˆë‹¤!")
        else:
            st.success("ğŸŒ³ ìµœê³  ë ˆë²¨ ë‹¬ì„±! ëª°ì… ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤!")
        
        # ìµœê·¼ ì„¸ì…˜
        st.markdown("### ğŸ“ ìµœê·¼ ëª°ì… ê¸°ë¡")
        recent_sessions = sorted(user_sessions, key=lambda x: x['date'], reverse=True)[:5]
        
        for session in recent_sessions:
            date = datetime.fromisoformat(session['date']).strftime('%Y-%m-%d %H:%M')
            duration = format_time(session.get('duration', 0))
            topic = session.get('topic', 'ì£¼ì œ ì—†ìŒ')
            
            with st.expander(f"ğŸ“… {date} | â±ï¸ {duration}"):
                st.markdown(f"**ì£¼ì œ:** {topic}")
                thoughts = session.get('thoughts', [])
                if thoughts:
                    st.markdown("**ê¸°ë¡ëœ ìƒê°ë“¤:**")
                    for t in thoughts:
                        st.markdown(f"- [{t['time']}] {t['content']}")

elif st.session_state.page == "report":
    st.markdown("## ğŸ“ ëª°ì… ì‹¤ì²œ ë³´ê³ ì„œ")
    
    user_sessions = [s for s in sessions if s.get('user') == st.session_state.user_name]
    
    if not user_sessions:
        st.warning("ì•„ì§ ëª°ì… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        today = datetime.now().strftime('%Y-%m-%d')
        today_sessions = [s for s in user_sessions if s.get('date', '').startswith(today)]
        
        if today_sessions:
            level, emoji, _ = get_user_level(len(user_sessions))
            total_time_today = sum(s.get('duration', 0) for s in today_sessions)
            
            # ë³´ê³ ì„œ ìƒì„±
            report_container = st.container()
            with report_container:
                report = f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ëª°ì… ì‹¤ì²œ ë³´ê³ ì„œ

ğŸ“… ì‘ì„±ì¼: {datetime.now().strftime('%Yë…„ %mì›” %dì¼ %H:%M')}
ğŸ‘¤ ì‘ì„±ì: {st.session_state.user_name}
{emoji} ë ˆë²¨: {level}

ã€ì˜¤ëŠ˜ì˜ ëª°ì…ã€‘
â€¢ ëª°ì… íšŸìˆ˜: {len(today_sessions)}íšŒ
â€¢ ì´ ëª°ì… ì‹œê°„: {format_time(total_time_today)}
â€¢ ëˆ„ì  ëª°ì…: {len(user_sessions)}íšŒ

ã€ì„¸ë¶€ ë‚´ìš©ã€‘"""
                
                for i, session in enumerate(today_sessions, 1):
                    topic = session.get('topic', '')
                    duration = format_time(session.get('duration', 0))
                    thoughts = session.get('thoughts', [])
                    
                    report += f"\n\n{i}. ì£¼ì œ: {topic}\n   ì‹œê°„: {duration}"
                    
                    if thoughts:
                        report += "\n   ê¸°ë¡:"
                        for t in thoughts:
                            report += f"\n   - [{t['time']}] {t['content']}"
                
                report += f"""

ã€ì˜¤ëŠ˜ì˜ ì„±ì¥ã€‘
í™©ë†ë¬¸ êµìˆ˜ë‹˜ì˜ '1ì´ˆ ì›ì¹™'ì„ ì‹¤ì²œí•˜ë©°
ì˜ì‹ì˜ ì¡°ëª…ì„ í•œ ê³³ì— ì§‘ì¤‘í•˜ëŠ” í›ˆë ¨ì„ ê³„ì†í–ˆìŠµë‹ˆë‹¤.

{st.session_state.user_name} ì˜¬ë¦¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
                
                st.text_area("ë³´ê³ ì„œ ë‚´ìš©", report, height=400, key="report_text")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.download_button(
                        "ğŸ“¥ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ",
                        report,
                        file_name=f"ëª°ì…ë³´ê³ ì„œ_{datetime.now().strftime('%Y%m%d')}.txt",
                        mime="text/plain",
                        use_container_width=True
                    )
                
                with col2:
                    if st.button("ğŸ¯ ìƒˆ ëª°ì… ì‹œì‘", type="primary", use_container_width=True):
                        st.session_state.page = "immersion"
                        st.session_state.immersion_step = 1
                        st.rerun()
        else:
            st.info("ì˜¤ëŠ˜ì˜ ëª°ì… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            if st.button("ğŸ¯ ëª°ì… ì‹œì‘í•˜ê¸°", type="primary", use_container_width=True):
                st.session_state.page = "immersion"
                st.session_state.immersion_step = 1
                st.rerun()

elif st.session_state.page == "help":
    help_container = st.container()
    with help_container:
        st.markdown("""
        ## â„¹ï¸ ì‚¬ìš© ê°€ì´ë“œ
        
        ### ğŸ¯ í”„ë¡œê·¸ë¨ íŠ¹ì§•
        
        **ê¹œë¹¡ì„ ì—†ëŠ” ì•ˆì •ì ì¸ UI**
        - ìë™ ìƒˆë¡œê³ ì¹¨ ìµœì†Œí™”ë¡œ í¸ì•ˆí•œ ì‚¬ìš© ê²½í—˜
        - íƒ€ì´ë¨¸ëŠ” ìˆ˜ë™ ì—…ë°ì´íŠ¸ ë²„íŠ¼ìœ¼ë¡œ í™•ì¸
        - ëª¨ë“  ë‚´ìš©ì´ ì•ˆì •ì ìœ¼ë¡œ í‘œì‹œë¨
        
        ### ğŸ“± í™©ë†ë¬¸ êµìˆ˜ë‹˜ê»˜ ì²´í—˜ ì œê³µ ë°©ë²•
        
        **1. ì˜¨ë¼ì¸ ë°°í¬ (ê¶Œì¥)**
        ```
        1. GitHubì— ì½”ë“œ ì—…ë¡œë“œ
        2. Streamlit Cloudì—ì„œ ë¬´ë£Œ ë°°í¬
        3. ìƒì„±ëœ URL ê³µìœ 
        ```
        
        **2. ë¡œì»¬ ì‹¤í–‰**
        ```
        1. Python ì„¤ì¹˜ (3.8 ì´ìƒ)
        2. pip install streamlit
        3. streamlit run app.py
        4. ìë™ìœ¼ë¡œ ì—´ë¦¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì²´í—˜
        ```
        
        ### ğŸ’¡ í”„ë¡œê·¸ë¨ ë¹ ë¥¸ ì‹¤í–‰ (Windows)
        
        **ì‹¤í–‰ íŒŒì¼ ë§Œë“¤ê¸°:**
        1. ë©”ëª¨ì¥ ì—´ê¸°
        2. ì•„ë˜ ë‚´ìš© ì…ë ¥:
        ```batch
        @echo off
        cd í”„ë¡œê·¸ë¨ê²½ë¡œ
        streamlit run app.py
        ```
        3. "ëª°ì…ì‹œì‘.bat"ë¡œ ì €ì¥
        4. ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
        
        ### ğŸ“ˆ ë ˆë²¨ ì‹œìŠ¤í…œ
        
        - ğŸŒ± **ì´ˆê¸‰** (0-4íšŒ): ê¸°ì´ˆ ëª°ì… í›ˆë ¨
        - ğŸŒ¿ **ì¤‘ê¸‰** (5-19íšŒ): ì‹¬í™” ëª°ì… í›ˆë ¨
        - ğŸŒ³ **ê³ ê¸‰** (20íšŒ+): ëª°ì… ë§ˆìŠ¤í„°
        
        ### ğŸ”§ ë¬¸ì œ í•´ê²°
        
        **í”„ë¡œê·¸ë¨ì´ ëŠë¦° ê²½ìš°:**
        - íƒ€ì´ë¨¸ ìë™ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™”ë¨
        - "íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸" ë²„íŠ¼ìœ¼ë¡œ ì‹œê°„ í™•ì¸
        
        **ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•ŠëŠ” ê²½ìš°:**
        - immersion_data í´ë” í™•ì¸
        - ì“°ê¸° ê¶Œí•œ í™•ì¸
        """)

# í‘¸í„°
st.markdown("---")
st.markdown("<div style='text-align: center; color: gray;'>Â© 2025 ì§ì¥ì¸ ëª°ì… ì²´í—˜ í”„ë¡œê·¸ë¨ | í™©ë†ë¬¸ êµìˆ˜ë‹˜ì˜ ëª°ì… ì² í•™ ê¸°ë°˜ | Made with â¤ï¸ by í•œìŠ¹í¬</div>", unsafe_allow_html=True)